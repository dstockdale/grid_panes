#!/usr/bin/env bash

# GridPanes Kamal Deployment Script
set -e

echo "ğŸš€ GridPanes Kamal Deployment"
echo "=============================="

# Check if .env exists
if [ ! -f .env ]; then
    echo "âŒ .env file not found!"
    echo "ğŸ“‹ Please copy .env.example to .env and fill in your values:"
    echo "   cp .env.example .env"
    echo "   Edit .env with your actual values"
    exit 1
fi

# Source environment variables
source .env

# Check required variables
required_vars=("SECRET_KEY_BASE" "LIVE_VIEW_SIGNING_SALT" "DATABASE_URL" "POSTGRES_PASSWORD" "SERVER_IP")
for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "âŒ Required environment variable $var is not set in .env"
        exit 1
    fi
done

echo "âœ… Environment variables validated"

# Update deploy.yml with actual values
echo "ğŸ“ Updating deploy.yml with your configuration..."
sed -i.bak \
    -e "s/YOUR_SERVER_IP/$SERVER_IP/g" \
    -e "s/your-domain.com/$DOMAIN/g" \
    -e "s/your-email@example.com/$EMAIL/g" \
    -e "s/your-dockerhub-username/$DOCKER_USERNAME/g" \
    config/deploy.yml

echo "ğŸ—ï¸  Building and deploying with Kamal..."

# Deploy with Kamal
kamal setup

echo "âœ… Deployment complete!"
echo "ğŸŒ Your app should be available at: https://$DOMAIN"
echo "ğŸ“Š Check status with: kamal app logs"